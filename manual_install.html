<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="keywords" content="">

    <title>UNIT3D Documentation</title>

    <!-- Styles -->
    <link href="assets/css/page.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png">
    <link rel="icon" href="assets/img/favicon.png">
</head>

<body>


<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-stick-dark" data-navbar="sticky">
    <div class="container">

        <div class="navbar-left">
            <button class="navbar-toggler" type="button">&#9776;</button>
            <a class="navbar-brand" href="index.html">
                <h2 style="color: black; font-weight: 800;">UNIT3D-Docs</h2>
            </a>
        </div>

        <section class="navbar-mobile">
            <span class="navbar-divider d-mobile-none"></span>

            <ul class="nav nav-navbar">

                <li class="nav-item">
                    <a class="nav-link" href="#">UNIT3D <span class="arrow"></span></a>
                    <nav class="nav">
                        <a class="nav-link" href="intro.html">Introduction</a>
                        <a class="nav-link" href="dir_structure.html">Directory Schema</a>
                        <a class="nav-link" href="#">Database Schema</a>
                        <div class="dropdown-divider"></div>
                        <a class="nav-link" href="article_system.html">Article System</a>
                        <a class="nav-link" href="#">Bonus System</a>
                        <a class="nav-link" href="#">Chat System</a>
                        <a class="nav-link" href="#">Forum System</a>
                        <a class="nav-link" href="#">Staff Dashboard</a>
                        <a class="nav-link" href="#">Torrent System</a>
                        <a class="nav-link" href="#">User System</a>
                    </nav>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">Installing <span class="arrow"></span></a>
                    <nav class="nav">
                        <a class="nav-link" href="automated_install.html">Automated Installer</a>
                        <a class="nav-link" href="manual_install.html">Manual Install</a>
                    </nav>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">Updating <span class="arrow"></span></a>
                    <nav class="nav">
                        <a class="nav-link" href="git_updater.html">Git Updater</a>
                    </nav>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">Changelog <span class="arrow"></span></a>
                    <nav class="nav">
                        <a class="nav-link" href="changelog.html">UNIT3D Changelog</a>
                    </nav>
                </li>

            </ul>
        </section>
    </div>
</nav>
<!-- /.navbar -->

<!-- Header -->
<header class="header" style="background-image: linear-gradient(135deg, #f9f7ff 0%, #e4e8ff 50%, #c8ceff 100%);">
    <div class="container">
        <div class="row align-items-center">

            <div class="col-lg-6">
                <h1>UNIT3D Manual Install</h1>
                <p class="lead mt-5 mb-8">Thinking about using UNIT3D? This page describes how to manually install
                    UNIT3D.</p>
            </div>

            <div class="col-lg-5 ml-auto d-none d-lg-block">
                <img src="assets/img/vector/2.png" style="height: 300px;" alt="img">
            </div>

        </div>
    </div>
</header>
<!-- /.header -->

<!-- Main Content -->
<main class="main-content">
    <div class="row">
        <div class="container">

            <h2 id="install">Manual Install<a class="anchor" href="#install"></a></h2>

            <pre class="code-dark">

Prerequisites Example:

1. ## Install OS

    `Ubuntu Server 17.10 "Artful Aardvark" (64bits)`

    or

    `Ubuntu Server 16.04.4 LTS "Xenial Xerus" (64bits)`
            </pre>

            <pre class="code-dark">
2. ## Repositories

    ```
    sudo add-apt-repository -y ppa:nginx/development
    sudo add-apt-repository -y ppa:ondrej/php
    sudo apt-get update
    ```
            </pre>

            <pre class="code-dark">
3. ## Required Software

    #### Tools
    ```
    sudo apt-get install -y git tmux vim curl wget zip unzip htop nano build-essential
    ```

    #### Supervisor
    ```
    sudo apt-get install supervisor
    ```

    #### Redis
    ```
    sudo apt-get install redis-server
    ```

    #### Nginx
    ```
    sudo apt-get install -y nginx
    ```

    #### PHP
    ```
    sudo apt-get install php-pear php7.3-curl php7.3-dev php7.3-gd php7.3-mbstring php7.3-zip php7.3-mysql php7.3-xml php7.3-fpm php7.3-intl php7.3-bcmath
    ```

    #### NodeJS and NPM
    ```
    curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
    sudo apt-get install -y nodejs
    ```

    #### Laravel Echo Server (for socket.io and broadcasting)
    ```
    sudo npm install -g laravel-echo-server
    ```
            </pre>

            <pre class="code-dark">
4. ## Configure PHP

    ```
    sudo nano /etc/php/7.3/fpm/php.ini
    ```

    FIND
    ```
    ;cgi.fix_pathinfo=1
    ```
    REPLACE WITH
    ```
    cgi.fix_pathinfo=0
    ```

    Save and close

	Now restart php-fpm
    ```
    sudo systemctl restart php7.3-fpm
    ```
            </pre>

            <pre class="code-dark">
 5. ## Install MySQL

    ```
    sudo apt-get install mysql-server
    ```

    ```
    mysql_secure_installation
    ```
            </pre>

            <pre class="code-dark">
 6. ## Configure Nginx

    ```
    sudo nano /etc/nginx/sites-available/default
    ```

    ```
    server {
    listen 80 default_server;

    root /var/www/html/public;

    index index.html index.htm index.php;

    server_name yourdomain.com;

    location ~* .(jpg|jpeg|png|gif|ico|svg)$ {
        expires 365d;
    }

    location ~ .(gif|png|jpg|jpeg|svg|css|js|ico)$ {
        valid_referers none blocked yourdomain.com www.yourdomain.com;
        if ($invalid_referer) {
            return   403;
        }
    }

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    location ~ \.php$ {
       include snippets/fastcgi-php.conf;
       fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;
    }
    }
    ```
    Save and close.

	Now restart nginx
    ```
    sudo systemctl reload nginx
    ```
            </pre>

            <pre class="code-dark">
7. ## Secure Nginx with Let's Encrypt

    https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-16-04

    **Note:** If you are using `ufw` or any other firewall you will need to `allow` port `8443` for the next step.

    With `ufw` you can do this simply by running:
    ```
    sudo ufw allow 8443 && sudo ufw allow ssh && sudo ufw enable
    ```
            </pre>

            <pre class="code-dark">
8. ## Main
    Open a terminal and SSH into your server.

    Run `cd /var/www/html/`

    Run `git clone https://github.com/HDInnovations/UNIT3D`

    Run
    `sudo chown -R www-data: storage bootstrap public config && sudo find . -type d -exec chmod 0755 '{}' + -or -type f -exec chmod 0644 '{}' +`

    Run `php -r "readfile('http://getcomposer.org/installer');" | sudo php -- --install-dir=/usr/bin/ --filename=composer`

    Rename `.env.example` to `.env` and fill it with your APP, DB, REDIS, API KEYS and MAIL info.

    Run `composer install && composer require predis/predis && npm install && npm install --save-dev socket.io-client && npm run prod`

    Setup your CRON `crontab -e`
    `* * * * * php /path/to/artisan schedule:run >> /dev/null 2>&1` to crontab.
    `/path/to/artisan` becomes whatever directory you put the codebase on your server.
    Example `* * * * * php /var/www/html/artisan schedule:run >> /dev/null 2>&1`

    Run `php artisan key:generate`

    Run `php artisan migrate --seed`

    Run `sudo chown -R www-data: storage bootstrap public config`

    **Note:**
    If you recieve a error during `npm install` regarding `pngquant-bin@4.0.0` OR an error similar to `... binary         doesn't seem to work correctly` please run the following command
```
wget -q -O /tmp/libpng12.deb http://mirrors.kernel.org/ubuntu/pool/main/libp/libpng/libpng12-0_1.2.54-1ubuntu1_amd64.deb && sudo dpkg -i /tmp/libpng12.deb && rm /tmp/libpng12.deb && npm install && npm run prod
```
            </pre>

            <pre class="code-dark">
9. ## Initialize Laravel Echo Server
    Run:
    ```
    laravel-echo-server init
    ```
    The cli tool will help you setup a laravel-echo-server.json file in the root directory of your project (/var/www/html/).

    This file will be loaded by the server during start up. You may edit this file later on to manage the configuration
    of your server.

    `? Do you want to run this server in development mode?` = `No` (Yes for debug or developement)

    `? Which port would you like to serve from?` = `8443`

    `? Which database would you like to use to store presence channel members?` = `redis`

    `? Enter the host of your Laravel authentication server.` = `https://yourdomain.com`

    `? Will you be serving on http or https?` = `https`

    `? Do you want to generate a client ID/Key for HTTP API?` = `Yes`

    `? Do you want to setup cross domain access to the API?` = `No`

    #### You should see something like the following
    ```
    appId: 73e82e6e1122cb58
    key: 95eacbe008a722b247653afba0247c44
    Configuration file saved. Run laravel-echo-server start to run server.
    ```
    #### Note: DO NOT Run the start command !!!
    The server should start automatically after loaded into Supervisor in the next section.

    **Note:** If you are using SSL **(HTTPS)**, you will want to make sure that the certificate files are readable by
     the user running the echo server.

    For example if you are using `LetsEncrypt` for SSL, you may need to run a command like:
    ```
    sudo chown www-data /etc/letsencrypt -R
    ```
            </pre>

            <pre class="code-dark">
10. ## Configure Supervisor

    ```
    sudo nano /etc/supervisor/conf.d/unit3d.conf
    ```

    Example:

    ```
    [program:unit3d-queue]
    process_name=%(program_name)s_%(process_num)02d
    command=php /var/www/html/artisan queue:work --sleep=3 --tries=3
    startsecs = 0
    autostart=true
    autorestart=true
    user=www-data
    numprocs=2

    [program:unit3d-socket-io]
    process_name=%(program_name)s_%(process_num)02d
    command=/usr/bin/node /usr/bin/laravel-echo-server start --dir=/var/www/html
    autostart=true
    autorestart=true
    user=www-data
    numprocs=1
    ```

    **Notes:**

    `command=php /var/www/html ...` change this to the absolute path to the root of your site files where the `artisan` file resides.

    `user=www-data` you will probably want to change to something like your web server be it `apache` or `www-data`

    `--dir=/var/www/html` change this to the absolute path to the root of your site files

    Once this is done, save and close!

    Next lets load new config and start the process.

    Run:
    ```
    sudo supervisorctl reread && sudo supervisorctl update && sudo supervisorctl reload
    ```

    Make sure there running and all is good!

    Run:
    ```
    sudo supervisorctl
    ```

    If you see something like following your good to go!
    ```
    unit3d-queue:unit3d-queue_00           RUNNING   pid 12838, uptime 0:00:10
    unit3d-queue:unit3d-queue_01           RUNNING   pid 12833, uptime 0:00:10
    unit3d-socket-io:unit3d-socket-io_01   RUNNING   pid 12828, uptime 0:00:10
    ```
    **Note:** type `exit` at the prompt to exit supervisorctl

    Run:
    ```
    sudo supervisorctl reload
    ```
            </pre>

            <pre class="code-dark">
11. ## Enjoy
    Go to your sites URL.

    Login with the username `UNIT3D` and the password `UNIT3D`.
    **Note:** whatever you set in the `.env` if changed from defaults.

    Edit `config/app.php` and `config/other.php` (These house some basic settings. Be sure to visit the config manager from staff dashboard after up and running and review everything!)

    Enjoy using UNIT3D.
            </pre>

        </div>
    </div>
</main>
<!-- /.main-content -->

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="row gap-y align-items-center">
            <div class="col-md-12 text-center text-md-right">
                <a href="#">© UNIT3D Docs</a>
            </div>
        </div>
    </div>
</footer><!-- /.footer -->


<!-- Scripts -->
<script src="assets/js/page.min.js"></script>
<script src="assets/js/script.js"></script>

</body>
</html>
